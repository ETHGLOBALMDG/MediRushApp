<!DOCTYPE html>
<html>

<head>
    <title>MetaMask Hedera Connect</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 400px;
            margin: 50px auto;
            padding: 20px;
            text-align: center;
        }

        button {
            background-color: #f6851b;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
        }

        button:hover {
            background-color: #e2761b;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            background-color: #f5f5f5;
        }

        .loading {
            display: none;
        }
    </style>
</head>

<body>
    <h1>MetaMask Hedera DApp</h1>

    <button id="connectBtn" onclick="connectWallet()">Connect Wallet</button>
    <button id="sendTxBtn" onclick="sendTransaction()" style="display: none;" disabled>Send HBAR</button>

    <div class="status" id="status">Status: Click to connect your wallet</div>
    <div class="loading" id="loading">Processing...</div>

    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js" type="application/javascript"></script>

    <script>
        let userAddress;

        const HEDERA_CHAIN_ID = "0x128"; // Hedera Testnet (296)
        const HBAR_DECIMALS = 8;

        const CONTRACT_ABI = [
            {
                "type": "function",
                "name": "fetchBlobID",
                "constant": true,
                "stateMutability": "view",
                "payable": false,
                "inputs": [
                    {
                        "type": "string",
                        "name": "_patientID"
                    }
                ],
                "outputs": [
                    {
                        "type": "string",
                        "name": ""
                    }
                ]
            },
            {
                "type": "function",
                "name": "updateBlobID",
                "constant": false,
                "payable": false,
                "inputs": [
                    {
                        "type": "string",
                        "name": "_patientID"
                    },
                    {
                        "type": "string",
                        "name": "_newBlobID"
                    }
                ],
                "outputs": []
            },
            {
                "type": "function",
                "name": "updateID",
                "constant": false,
                "payable": false,
                "inputs": [
                    {
                        "type": "string",
                        "name": "_prevID"
                    },
                    {
                        "type": "string",
                        "name": "_newID"
                    }
                ],
                "outputs": []
            }
        ];

        // --- NEW GLOBAL STATE FOR CONTRACT CALL ---
        let contractAddressFromURL;
        let functionNameFromURL;
        let functionParamsFromURL;
        // --- END NEW STATE ---

        // Initialize the interface using the ABI (This requires Ethers.js)
        let contractInterface;
        try {
            if (typeof ethers !== 'undefined') {
                contractInterface = new ethers.utils.Interface(CONTRACT_ABI);
            }
        } catch (e) {
            console.error("Ethers or ABI initialization failed:", e);
        }

        // --- NEW FUNCTION TO PARSE URL DATA ---
        function parseDeepLinkData() {
            const urlParams = new URLSearchParams(window.location.search);

            contractAddressFromURL = urlParams.get('contract');
            functionNameFromURL = urlParams.get('function');
            const paramsJson = urlParams.get('params');

            if (paramsJson) {
                try {
                    // Decode URI component (e.g., handles spaces/symbols if not perfectly clean)
                    const decodedJson = decodeURIComponent(paramsJson);
                    functionParamsFromURL = JSON.parse(decodedJson);
                    console.log("Parsed Params:", functionParamsFromURL);
                } catch (e) {
                    console.error("Failed to parse JSON parameters:", e);
                }
            }

            if (functionNameFromURL) {
                document.getElementById("sendTxBtn").innerText = `Execute: ${functionNameFromURL}`;
            }
        }
        // --- END PARSE FUNCTION ---

        function checkMetaMask() {
            if (typeof window.ethereum === "undefined") {
                document.getElementById("status").innerText = "MetaMask not detected";
                setTimeout(() => {
                    window.location.href = "verimed://callback?error=" + encodeURIComponent("MetaMask not installed");
                }, 2000);
                return false;
            }
            return true;
        }

        async function connectWallet() {
            const connectBtn = document.getElementById("connectBtn");
            const status = document.getElementById("status");

            if (!checkMetaMask()) return;

            try {
                connectBtn.disabled = true;
                status.innerText = "Connecting to MetaMask...";

                // MetaMask requires 18 decimals for native currency
                await window.ethereum.request({
                    method: "wallet_addEthereumChain",
                    params: [{
                        chainId: HEDERA_CHAIN_ID,
                        chainName: "Hedera Testnet",
                        nativeCurrency: {
                            name: "HBAR",
                            symbol: "HBAR",
                            decimals: 18   // MetaMask enforces 18 decimals for native currency
                        },
                        rpcUrls: ["https://testnet.hashio.io/api"],
                        blockExplorerUrls: ["https://testnet.hashscan.io"]
                    }]
                });

                // Switch to the chain after adding it
                await window.ethereum.request({
                    method: "wallet_switchEthereumChain",
                    params: [{ chainId: HEDERA_CHAIN_ID }]
                });

                const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
                userAddress = accounts[0];

                status.innerText = `Connected: ${userAddress.substring(0, 6)}...${userAddress.substring(38)}`;

                document.getElementById("connectBtn").style.display = "none";
                document.getElementById("sendTxBtn").style.display = "inline-block";
                document.getElementById("sendTxBtn").disabled = false;

            } catch (err) {
                console.error("Connection error:", err);
                status.innerText = "Connection failed: " + err.message;
                connectBtn.disabled = false;

                setTimeout(() => {
                    window.location.href = "verimed://callback?error=" + encodeURIComponent(err.message);
                }, 3000);
            }
        }

        // --- MODIFIED sendTransaction function ---

        async function sendTransaction() {
            const sendTxBtn = document.getElementById("sendTxBtn");
            const status = document.getElementById("status");
            const loading = document.getElementById("loading");

            if (!userAddress || !checkMetaMask() || !contractAddressFromURL || !functionNameFromURL) {
                status.innerText = "Error: Missing connection or contract details.";
                return;
            }

            try {
                sendTxBtn.disabled = true;
                loading.style.display = "block";

                // 1. DETERMINE FUNCTION TYPE
                const fragment = contractInterface.getFunction(functionNameFromURL);

                if (fragment.stateMutability === 'view' || fragment.constant === true) {
                    // --- A. HANDLE READ-ONLY (VIEW/PURE) CALLS ---
                    status.innerText = `Executing view function: ${functionNameFromURL}...`;

                    // Extract arguments for the call
                    const argsArray = Object.values(functionParamsFromURL || {});

                    // This requires a provider, typically available via window.ethereum
                    const provider = new ethers.providers.Web3Provider(window.ethereum);
                    const signer = provider.getSigner();

                    // Initialize a contract object to perform the call
                    const contract = new ethers.Contract(contractAddressFromURL, CONTRACT_ABI, signer);

                    // Execute the read-only call
                    const result = await contract[functionNameFromURL](...argsArray);

                    console.log("View call result:", result);
                    loading.style.display = "none";

                    // Handle success: display result and provide callback link
                    status.innerHTML = `âœ… Call Success! Result: ${result.toString().substring(0, 50)}...<br><br><a href="verimed://callback?status=success&result=${encodeURIComponent(result)}"><button>Return to App</button></a>`;

                    return; // Exit here after a successful read call
                }

                // --- B. HANDLE WRITE (STATE-CHANGING) CALLS ---
                status.innerText = `Preparing call to ${functionNameFromURL}...`;

                // 2. ABI ENCODING (Only for state-changing transactions)
                const argsArray = Object.values(functionParamsFromURL || {});
                const encodedCallData = contractInterface.encodeFunctionData(functionNameFromURL, argsArray);

                // Convert 1 HBAR to Wei (18 decimals)
                const hbarAmount = 1;
                const weiAmount = BigInt(hbarAmount) * BigInt(10 ** 18);
                const value = "0x" + weiAmount.toString(16);

                // Get gas price estimate (unchanged)
                let gasPrice;
                try {
                    gasPrice = await window.ethereum.request({ method: "eth_gasPrice" });
                } catch (e) {
                    gasPrice = "0x1";
                }

                // 3. Send Transaction
                const txHash = await window.ethereum.request({
                    method: "eth_sendTransaction",
                    params: [{
                        from: userAddress,
                        to: contractAddressFromURL,
                        value: value,
                        gas: "0x493E0", // 300,000 gas
                        gasPrice: gasPrice,
                        data: encodedCallData,
                    }]
                });

                // 4. Success and Redirect
                console.log("Transaction sent:", txHash);
                loading.style.display = "none";

                const redirectUrl = `verimed://callback?status=success&txHash=${txHash}`;
                status.innerHTML = `Transaction sent! Hash: ${txHash.substring(0, 10)}...<br><br><a href="${redirectUrl}"><button>Return to App</button></a>`;

            } catch (err) {
                // ... (Error handling remains the same) ...
                console.error("Transaction error:", err);
                sendTxBtn.disabled = false;
                loading.style.display = "none";

                let errorMessage = err.code === 4001 ? "User rejected the transaction." : err.message;

                const redirectUrl = `verimed://callback?status=failure&error=${encodeURIComponent(errorMessage)}`;
                status.innerHTML = `Transaction failed: ${errorMessage}<br><br><a href="${redirectUrl}"><button>Return to App</button></a>`;
            }
        }

        // Auto-connect if already connected
        document.addEventListener("DOMContentLoaded", function () {
            parseDeepLinkData();
            if (typeof window.ethereum !== "undefined") {
                window.ethereum.request({ method: "eth_accounts" }).then(accounts => {
                    if (accounts.length > 0) {
                        connectWallet();
                    }
                }).catch(err => {
                    console.log("Auto-connect failed:", err);
                });
            }
        });

        // Handle account changes
        if (typeof window.ethereum !== "undefined") {
            window.ethereum.on("accountsChanged", function (accounts) {
                if (accounts.length > 0) {
                    userAddress = accounts[0];
                    document.getElementById("status").innerText =
                        `Connected: ${userAddress.substring(0, 6)}...${userAddress.substring(38)}`;
                } else {
                    userAddress = null;
                    document.getElementById("status").innerText = "Disconnected";
                    document.getElementById("connectBtn").style.display = "inline-block";
                    document.getElementById("sendTxBtn").style.display = "none";
                }
            });

            // Handle chain changes
            window.ethereum.on("chainChanged", function (chainId) {
                console.log("Chain changed to:", chainId);
                if (chainId !== HEDERA_CHAIN_ID) {
                    document.getElementById("status").innerText = "Please switch back to Hedera Testnet";
                }
            });
        }
    </script>
</body>

</html>